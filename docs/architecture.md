# Архитектура Shopping Bot

## Общая структура

Shopping Bot построен на модульной архитектуре, где каждый компонент отвечает за определенную функциональность. Это обеспечивает легкость поддержки, расширения и тестирования.

```
shopping-bot/
├── config/                 # Конфигурационные файлы
│   └── default.js          # Основная конфигурация
├── docs/                   # Документация
├── logs/                   # Логи работы бота
├── screenshots/            # Скриншоты страниц продуктов
├── src/                    # Исходный код
│   ├── index.js            # Точка входа
│   ├── services/           # Сервисы
│   │   ├── aiAnalysisService.js    # Сервис AI-анализа скриншотов
│   │   ├── browserService.js       # Сервис для работы с браузером
│   │   ├── monitoringService.js    # Сервис мониторинга продуктов
│   │   ├── notificationService.js  # Сервис уведомлений
│   │   ├── productService.js       # Сервис для работы с продуктами
│   │   └── screenshotService.js    # Сервис для создания скриншотов
│   └── utils/              # Утилиты
│       └── logger.js       # Логгер
├── .env                    # Переменные окружения (не в репозитории)
├── .env.example            # Пример файла с переменными окружения
├── .gitignore              # Файлы, исключенные из Git
├── package.json            # Зависимости и скрипты
└── README.md               # Общее описание проекта
```

## Компоненты системы

### 1. Точка входа (index.js)

Основной файл, который инициализирует бота и настраивает расписание проверок с использованием cron.

### 2. Сервисы

#### 2.1. Сервис мониторинга (monitoringService.js)

Координирует процесс мониторинга продуктов:
- Запускает браузер
- Проверяет каждый продукт из конфигурации
- Отправляет уведомления при обнаружении доступных продуктов
- Обрабатывает ошибки и закрывает браузер

#### 2.2. Сервис продуктов (productService.js)

Отвечает за проверку доступности продуктов:
- Загружает страницу продукта
- Делает скриншот страницы
- Использует AI-анализ для определения доступности, цены и размеров
- При необходимости использует традиционный HTML-парсинг как резервный механизм
- Возвращает результат проверки

#### 2.3. Сервис AI-анализа (aiAnalysisService.js)

Анализирует скриншоты страниц продуктов с помощью OpenAI API:
- Отправляет скриншот в OpenAI API с запросом на анализ
- Обрабатывает ответ API
- Фильтрует доступные размеры
- Проверяет соответствие цены максимальной цене
- Предоставляет мок-анализ для разработки, если API ключ не настроен

#### 2.4. Сервис браузера (browserService.js)

Управляет браузером Puppeteer:
- Запускает браузер с нужными настройками
- Обрабатывает диалоги согласия на использование cookies
- Предоставляет функции для работы с браузером

#### 2.5. Сервис скриншотов (screenshotService.js)

Создает и сохраняет скриншоты страниц:
- Создает директорию для скриншотов, если она не существует
- Генерирует уникальные имена файлов с временными метками
- Сохраняет скриншоты и возвращает путь к сохраненному файлу

#### 2.6. Сервис уведомлений (notificationService.js)

Отправляет уведомления о доступных продуктах:
- Настраивает транспорт для отправки email
- Форматирует сообщения с информацией о продукте
- Отправляет уведомления на указанный email

### 3. Утилиты

#### 3.1. Логгер (logger.js)

Обеспечивает логирование работы бота:
- Настраивает форматы логов
- Создает директорию для логов
- Записывает логи в файлы и выводит в консоль
- Разделяет логи по уровням (info, error)

### 4. Конфигурация

#### 4.1. Основная конфигурация (default.js)

Содержит настройки бота:
- Список магазинов с их URL и настройками
- Список продуктов для мониторинга с их параметрами
- Настройки email для уведомлений
- Расписание проверок
- Настройки браузера

#### 4.2. Переменные окружения (.env)

Содержит чувствительные данные и настройки:
- Учетные данные для магазинов
- Настройки email
- API ключ OpenAI
- Расписание проверок
- Режим работы браузера

## Поток данных

1. **Инициализация**: `index.js` запускает процесс мониторинга по расписанию
2. **Мониторинг**: `monitoringService.js` запускает браузер и проверяет каждый продукт
3. **Проверка продукта**: `productService.js` загружает страницу продукта и делает скриншот
4. **AI-анализ**: `aiAnalysisService.js` анализирует скриншот и определяет доступность
5. **Резервный механизм**: Если AI-анализ не удался, используется традиционный HTML-парсинг
6. **Уведомление**: Если продукт доступен, `notificationService.js` отправляет уведомление
7. **Логирование**: На каждом этапе `logger.js` записывает информацию о процессе

## Расширение функциональности

### Добавление нового магазина

1. Добавьте конфигурацию магазина в `config/default.js`
2. AI-анализ должен работать автоматически для большинства магазинов

### Реализация автоматической покупки

1. Создайте новый сервис `src/services/purchaseService.js`
2. Реализуйте процесс покупки для каждого поддерживаемого магазина
3. Вызывайте сервис покупки из сервиса мониторинга, когда продукт доступен

## Обработка ошибок

Система имеет многоуровневую обработку ошибок:
1. **Уровень сервиса**: Каждый сервис обрабатывает свои ошибки и логирует их
2. **Уровень мониторинга**: `monitoringService.js` обрабатывает ошибки сервисов и продолжает работу
3. **Уровень приложения**: `index.js` обрабатывает фатальные ошибки и перезапускает процесс

## Резервные механизмы

1. **AI-анализ → HTML-парсинг**: Если AI-анализ не удается, используется традиционный HTML-парсинг
2. **Мок-анализ для разработки**: Если API ключ не настроен, используется мок-анализ
3. **Множество селекторов**: HTML-парсинг пытается использовать различные селекторы для поиска информации 