# Обход блокировок сайтов при мониторинге товаров

При работе Shopping Bot часто возникает проблема блокировки доступа к сайтам из-за систем защиты от автоматического сканирования. Это руководство поможет вам настроить бот для обхода таких блокировок.

## Признаки блокировки сайтом

1. **Сообщение "Access Denied"** - Классический признак блокировки Akamai или Cloudflare
2. **Перенаправление на страницу с CAPTCHA** - Требуется ручная верификация
3. **HTTP статус 403 Forbidden** - Доступ запрещен
4. **Соединение разрывается** - Частое прерывание соединения при попытках доступа
5. **Таймауты при загрузке** - Искусственное замедление запросов, особенно из-за защиты от ботов

## Решения проблемы

### 1. Использование прокси-серверов

В файле `run_low_resource.sh` добавлена поддержка прокси:

```bash
# Раскомментируйте эти строки в src/services/browserService.js:
# const { applyProxy } = require('../utils/rotateProxy');
# launchOptions = await applyProxy(launchOptions);
```

#### Добавление прокси-серверов:

Создайте файл `config/proxies.txt` в следующем формате:
```
ip:port
username:password@ip:port
```

### 2. Улучшенная имитация реального пользователя

Бот уже включает функции имитации человеческого поведения:
- Случайные задержки между действиями
- Разнообразные User Agent
- Имитация движений мыши и скроллинга

### 3. Организационные меры

- **Снизьте частоту проверок**: Используйте интервал не менее 4-6 часов между проверками
- **Проверяйте в разное время**: Настройте проверки на разное время суток
- **Разделите проверки**: Распределите проверки разных магазинов с интервалом

## Реализованный механизм проверки доступности

Теперь бот автоматически проверяет доступность сайта перед проверкой товаров:

```javascript
// Проверка доступности магазина
const siteCheck = await checkSiteAvailability(browser, shopConfig.url, shopName);

if (!siteCheck.available) {
  logger.error(`Shop ${shopName} is not available: ${siteCheck.reason}`);
  // Пропускаем проверку товаров...
}
```

### Что делает функция проверки:

1. Открывает главную страницу магазина
2. Проверяет наличие признаков блокировки
3. Проверяет HTTP статус ответа
4. Сохраняет скриншот при обнаружении блокировки
5. Проверяет страницу на наличие ключевых элементов магазина

## Что делать при блокировке

1. **Смените IP-адрес**: Если используете VPS, запросите новый IP у провайдера
2. **Используйте другие прокси**: Добавьте больше серверов в файл proxies.txt
3. **Увеличьте интервал**: Измените `CHECK_INTERVAL` в .env файле на более редкий
4. **Временно отключите проблемный магазин**: Закомментируйте соответствующие товары в config/default.js

## Пример настройки для обхода блокировок

```javascript
// В файле .env
CHECK_INTERVAL="0 */8 * * *" // Каждые 8 часов

// В файле config/default.js - расширьте настройки магазина
{
  name: 'Massimo Dutti',
  url: 'https://www.massimodutti.com',
  locale: '/ru',
  useProxy: true, // Добавьте этот параметр
  failureThreshold: 3, // Сколько неудач до временного отключения
  recoveryTime: 12, // Сколько часов ждать до повторной попытки
  cookieConsent: {
    selector: '.cookie-setting-link',
    timeout: 5000
  },
  credentials: {
    username: process.env.MASSIMO_DUTTI_USERNAME,
    password: process.env.MASSIMO_DUTTI_PASSWORD
  }
}
```

## Дополнительные настройки параметров браузера

Для более надежного обхода блокировок настройте параметры браузера, добавив эти строки в launchOptions в browserService.js:

```javascript
args: [
  // Существующие параметры...
  '--disable-blink-features=AutomationControlled',
  '--no-first-run',
  '--no-service-autorun',
  '--password-store=basic'
]
```

Эти функции уже встроены в текущую версию бота и должны помочь обойти большинство блокировок при правильной настройке.
